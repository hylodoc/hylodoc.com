{{ template "header" . }}

<section>
	<div class="container">
		<h3>Create new blog</h3>
	</div>
</section>

<section>
	<div class="container">
		<form id="blogForm" action="/user/create-new-blog" method="POST">
			{{ if not .Data.AccountDetails.IsLinked }}
				<p>
					To create a repository based site, you need to link a Github Account.
					<a href="gh/linkgithub">Link GitHub Account</a>
				</p>
			{{ end }}
			{{ if not .Data.AccountDetails.HasInstallation }}
				<p>
					To use the repository flow, you need to
					install our GitHub App and grant us
					access to the relevent repositories <a
					href="github-installation">Install
				GitHub App</a>
				</p>
			{{ else }}
				<p>
					To manage your Github Installations, add/remove repositories.
					<a href="github-installation">Manage Installations</a>
				</p>
			{{ end }}

			<!-- Select repository -->
			<div class="row">
				<div class="four columns">
					<label for="repositoriesDropdown">Select a repository</label>
					<select class="u-full-width" id="repositoriesDropdown" name="repositoriesDropdown" required>
						<option value="" disabled selected>···</option>
						{{ range .Data.Repositories }}
							<option value="{{ .Value }}">{{ .Name }}</option>
						{{ end }}
					</select>
					<div id="repositoryError" class="error-div">
						{{ .Data.RepositoryError }}
					</div>
				</div>
			</div>

			<!-- Subdomain configuration -->
			<label for="subdomainInput">Set subdomain</label>
			<div>
				<div class="row">
					<div class="four columns">
					<input class="u-full-width"
					autocomplete="off" type="text" id="subdomainInput" name="subdomainInput" placeholder="Enter subdomain" required/>
					</div>
					<span> .{{ .Data.RootDomain }}</span>
				</div>
				<div id="subdomainError" class="error-div">
					{{ .Data.SubdomainError }}
				</div>
			</div>

			<!-- Select theme -->
			<div class="row">
				<div class="four columns">
					<label for="themesDropdown">Select a theme</label>
					<select id="themesDropdown" name="themesDropdown" class="u-full-width" required>
						<option value="" disabled selected>···</option>
						{{ range .Data.Themes }}
							<option value="{{ . }}">{{ . }}</option>
						{{ end }}
					</select>
					<div id="themeErrror" class="error-div">
						{{ .Data.ThemeError }}
					</div>
				</div>
			</div>

			<!-- Submit git branch for live builds -->
			<div class="row">
				<label for="liveBranchInput">Set branch</label>
				<div class="row">
					<div class="four columns">
						<input class="u-full-width" type="text" id="liveBranchInput" name="liveBranchInput" placeholder="Enter branch" required/>
					</div>
				</div>
				<div id="branchError" class="error-div">
					{{ .Data.BranchError }}
				</div>
			</div>

			<br><br>

			<!-- Submit button -->
			<button type="submit">Launch</button>
		</form>
	</div>
</section>

<script>
	let debounceTimer;

	function init() {
		const subdomainInput = document.getElementById("subdomainInput");

		/* subdomain availability feedback */
		subdomainInput.addEventListener("input", handleInput);
	}

	/* handle input event with debounce */
	function handleInput() {
		const subdomain = this.value.trim();
		const subdomainErrorElement = document.getElementById("subdomainError");

		clearTimeout(debounceTimer); /* clear previous timer */

		if (subdomain.length > 0) {
			updateMessage(subdomainErrorElement, "Checking availability...", "loading");
		} else {
			resetMessage(subdomainErrorElement); /* Clear message if input is empty */
			return;
		}

		debounceTimer = setTimeout(() => {
			checkSubdomainAvailability(subdomain, subdomainErrorElement);
		}, 300); /* 300ms debounce delay */
	}

	/* Check subdomain availability */
	function checkSubdomainAvailability(subdomain, subdomainErrorElement) {
		fetch("/user/subdomain-check", {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify({ subdomain })
		})
		.then(response => response.json())
		.then(data => {
			if (data.available) {
				updateMessage(subdomainErrorElement, "✅ This subdomain is available!", "available");
			} else {
				updateMessage(subdomainErrorElement, "❌ " + data.message, "unavailable");
			}
		})
		.catch(error => handleError(error, subdomainErrorElement));
	}

	/* Update the availability message */
	function updateMessage(element, message, status) {
		element.textContent = message;
		element.className = `error-div ${status}`;
	}

	/* Reset the message and disable submit button */
	function resetMessage(subdomainErrorElement) {
		subdomainErrorElement.textContent = ""; /* Clear message */
	}

	/* Handle fetch errors */
	function handleError(error, subdomainErrorElement) {
		console.error("Error checking subdomain:", error);
		updateMessage(subdomainErrorElement, "⚠️ An error occurred while checking availability.", "unavailable");
	}

	/* Initialize the script on page load */
	document.addEventListener("DOMContentLoaded", init);
</script>

{{ template "footer" . }}
